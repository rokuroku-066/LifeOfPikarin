# 長期稼働キューブ・テラリウム設計

このドキュメントは実装済みの Phase 1（キューブ表示）を前提に、`src/terrarium/world.py` と `src/terrarium/static/app.js` の挙動と一致するように再整理したものです。Phase 2（FBX/アニメーション差し替え）は末尾の展望に残し、まだ実装しません。

## 0. 目的と設計の基本原則

* **目的**: 長時間眺められる映像作品としての箱庭シミュレーションを成立させる。そのために決定論的な固定Δtで安定稼働させ、人口爆
発や全滅を抑えつつ、グループ化・離散的なフィードバックをキューブ表現で提示する。
* **基本原則（実装と一致）**
  * Simulation は固定ステップで進み、`DeterministicRng` を用いて seed 再現性を維持。ビューやフレーム時間に依存しない。
  * 空間検索は `SpatialGrid` に限定し、近傍セルのみを見ることで O(N²) を回避。
  * ストレス・疾病・エネルギー代謝・繁殖抑制・危険回避で人口の負帰還を維持し、死亡時は資源を環境へ戻す。
  * シミュレーションと View は疎結合で、`World.snapshot` の JSON を補間表示するだけに留め、Sim のステップを遅延させない。
  * 環境フィールド（食料・危険・フェロモン・グループ食料）は決まった間隔でまとめて減衰/拡散し、決定論的ノイズで揺らぎを与える。

## 1. 全体構成と責務

* **Simulation Core (`src/terrarium/world.py`)**
  * 決定論的 RNG（種付き `DeterministicRng`）で固定ステップ進行（既定 `dt=1/50`）。
  * `SpatialGrid` による近傍検索だけで意思決定と Steering を行い、O(N²) を回避。
  * `EnvironmentGrid` が食料・危険・フェロモン・グループ食料のフィールドを管理し、`environment_tick_interval` 間隔でディフュージョン/減衰と気候ノイズ補正をまとめて処理。
  * 反射境界＋境界マージン内のソフト回避（`boundary_avoidance_weight` / `boundary_turn_weight`）でワールド外に出ない。

* **Web サーバー / スナップショット配信**
  * `World.snapshot` は全個体・メトリクス・環境フィールドを JSON 化し、WebSocket `/ws` で配信する。
  * `/api/control/{start,stop,reset,speed}` でシミュレーション操作（`app.js` から fetch）。

* **View (`src/terrarium/static/app.js`)**
  * three.js の `InstancedMesh` でキューブを描画。トップダウン＋角度＋POV の3ビューを同時表示し、レイアウトは `ResizeObserver` で自動リフロー。
  * スナップショット間を補間してカメラ・姿勢・色をスムーズに表示。1 体を自動トラッキングし、POV カメラを追従。
  * 色相＝グループタグ、明度＝エネルギー、スケール＝成長＋再生欲求パルスという単純な視覚マッピングを維持。

## 2. 主要データとパラメータ

* **ワールド**: 正方形 `world_size=100`。`cell_size=5.5` のグリッドで空間を量子化。
* **エージェント**
  * 位置・速度・heading、エネルギー、年齢、stress、グループID（-1 は未所属）。
  * Wander 用の方向ベクトルと残り時間、グループ孤立時間、グループ合流クールダウンを保持。
  * `size` は年齢とエネルギーから動的算出（子供小さめ、エネルギー高でわずかに拡大）。
  * 遺伝トレイトは `speed` / `metabolism` / `disease_resistance` / `fertility` に加え、社会・系譜要素として `sociality` / `territoriality` / `loyalty` / `founder` / `kin_bias` を持つ（既定 1.0）。`sociality` はグループ採用確率と Cohesion/Alignment 重みを増減させ、`territoriality` は他グループ回避ベクトルを強調し、`loyalty` は離脱までの猶予と乗り換え抑制に効く。`founder` は離脱・分裂・出生変異での新規グループ生成確率を引き上げ、`kin_bias` は系譜の近い隣人を多数派スコアへ加点する。
* **環境フィールド**
  * 食料: セル単位の量・拡散・回復、死亡時の食料返還。
  * 危険: 逃避行動のトリガーとなるパルス場（逃走で追加）。
  * フェロモン: グループごとのスカラー場、出生でデポジット、`prune_pheromones` で live group のみ維持。
  * グループ食料: 近距離仲間が多いとスポーン、グループメンバー優先で消費。
  * 食料パッチ: `resource_patches` で特定座標に高密度・高速再生のセルを敷き、ワールドの中に資源の山やオアシスを作る。
* **フィードバック系（抜粋）**: 近傍密度に応じたストレス・疾病・繁殖抑制、グループ形成/離脱/分裂のしきい値、他グループ回避半径、最小分離距離など。
* **環境ノイズ**: `food_regen_noise_*` により決定論的な気候ノイズを滑らかにサンプリングし、食料再生率を揺らす。

## 3. 1 tick の流れ（`World.step`）

1. **初期化**: ペンディングの食料/危険/フェロモン/グループ食料リストをクリア。グリッドを再構築し、グループサイズを集計。
2. **近傍収集**: ビジョン半径で `SpatialGrid.collect_neighbors_precomputed` を呼び、全エージェントについて近傍とオフセットを取得（事前計算したセルオフセットを使用）。
3. **グループ処理**:
   * 近距離仲間数で孤立時間を積算し、一定時間で離脱 or 乗り換え or 新規グループ生成。
   * 未所属は近傍多数派や既存ベース（拠点）への吸引で採用を試みる。
   * 近傍が多い既存グループは確率で分裂し、新グループへ近傍をリクルート。
4. **Steering/状態決定**（`_compute_desired_velocity`）:
   * 危険場 or 他グループ至近距離で逃走（FLEE）。
   * 空腹/豊富な食料セルでは食料勾配＋ワンダーに重み付け。繁殖条件を満たすと近傍 Cohesion とフェロモンを優先。通常は Wander＋フェロモン軽視覚。
   * 常時適用: 個人空間・最小分離・同盟/他グループ分離、グループ Cohesion/基点吸引、未所属のグループ探索、境界回避、他グループ回避半径の押し返し、危険場からの微弱回避。
   * 加速度・速度をクランプし、反射壁で位置/速度を補正。
5. **ライフサイクル**（`_apply_life_cycle`）:
   * 速度依存代謝＋高エネルギー追加コスト＋密度ストレスでエネルギー減少。過密セルでは疾病死の確率増。
   * グループ食料→セル食料の優先順で摂食。既定初期人口が十分な場合のみ繁殖を許可。
   * 繁殖はエネルギー・年齢・人口上限チェック後、密度と同盟人数に応じて確率が減衰。子は親の位置近傍に生まれ、グループは変異/新規生成する場合がある。
   * 死亡ハザード: 基礎＋加齢＋密度に人口圧（遅延付き）を加え、確率死を判定。エネルギー枯渇・寿命超過でも死亡。
6. **フィールドイベント適用**: 生死イベントで溜まった食料/危険/フェロモン/グループ食料の追加を環境へ反映。
7. **環境更新**: `environment_tick_interval` ごとにフィールドの拡散・減衰・ノイズ更新をバッチ適用し、不要なグループ層を pruning。気候ノイズは専用 RNG でサンプリングし、再現性を保ったまま再生量をゆっくり追従させる。
8. **メトリクス記録**: tick 時間、人口、出生/死亡数、平均エネルギー・年齢、グループ数、近傍チェック回数、未所属数を `TickMetrics` として保存し、スナップショットに載せる。

## 4. グループ形成・維持の仕掛け

* **形成**: 未所属で近傍未所属が閾値以上なら確率で新規グループ化し、その場に拠点（base）を記録。閾値は `group_formation_neighbor_threshold`。ピーク人口到達後にグループが途切れた場合は未所属から自動で seed し、残った未所属は既存グループへラウンドロビンで割り当てる。
* **採用・離脱**: 近傍多数派へ確率採用、孤立が続くと未所属化 or 新規グループ化。`sociality` が高いほど採用確率が上がり、既所属の場合は `loyalty` が大きいほど乗り換え確率が抑えられる。同じ系譜の隣人は `kin_bias` により多数派スコアへ加点され、系譜が近いグループへ寄りやすい。拠点半径内の未所属は弱い引力で帰巣しやすい。
* **分裂**: 近傍仲間が多くストレスが高いと確率で分裂し、新グループへ近傍を引き抜く。`founder` が高い個体は離脱や分裂時の新規グループ生成・出生/突然変異でのグループシード確率を引き上げる。ピーク人口到達後は最低グループ数を保証するため、未所属を割り振り seed する。
* **行動バイアス**: 同グループ Cohesion・Alignment は強め、他グループ Separation/回避半径で圧をかけ、未所属は近傍グループとベースに引かれる。`sociality` は Cohesion/Alignment 重みを増加させ、`territoriality` は他グループ回避ベクトルを強める。拠点は描画とは独立し、決定論を維持。

## 5. View/インタラクション設計（Phase 1）

* **描画**: Instanced cube（0.8m 基本）を三人称 2ビュー＋POV で同時レンダリング。レンダラーはフレーム時間に応じて `pixelRatio` を動的調整し、45fps 目標で描画負荷を平滑化。
* **補間**: WebSocket スナップショット間を位置/速度/heading/サイズで線形補間し、グループ Hue に対し HSL で色を算出。エネルギー→明度、繁殖欲求→脈動パルス、老化で縮小/揺らぎ。
* **UI**: tick・人口・POV 対象を表示。`start/stop/reset` ボタンと速度スライダで REST API を呼ぶ。接続状態をバッジ表示し、切断時は自動再接続。

## 6. 今後の拡張（Phase 2 プレースホルダー）

* FBX モデル＆アニメーションで代表個体を表現し、遠景はキューブのまま LOD 化。
* Animator は Sim の状態・速度・成長段階を受け取る片方向パラメータのみで、Sim のステップは固定Δtを維持。
* 追加の可視化（フェロモン・危険ヒートマップ、統計HUD）を検討。
